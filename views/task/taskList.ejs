<%- include('../home.ejs'); -%>
  <div class="container">
    <div class="row">
      <div class="col">
        <button class="btn btn-success m-4" data-toggle="modal" data-target="#exampleModaladd">
          Add Task
        </button>
      </div>
      <div class="col m-4">
        <div class="input-group mb-3">
          <input type="text" class="form-control" id="taskFilter" placeholder="Enter task name"
            aria-label="Recipient's username" aria-describedby="basic-addon2" />
          <div class="input-group-append">
            <button style="background-color: #d6ae7b" class="btn" type="button" onclick="taskFilter()">
              Search
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div>
    <table class="table table-hover">
      <thead>
        <tr>
          <th scope="col">No.</th>
          <th scope="col">Task name</th>
          <th scope="col">Task image</th>
          <th scope="col">Action</th>
          <th scope="col">Action</th>
          <th scope="col">Action</th>
        </tr>
      </thead>
      <tbody id="showMovies"></tbody>
    </table>
  </div>

  <div class="container">
    <div class="input-group">
      <div class="input-group-prepend">
        <span class="input-group-text" id="">Pagination</span>
      </div>
      <input type="text" class="form-control" id="skipNo" placeholder="enter no of skip data" />
      <input type="text" class="form-control" id="fetchNo" placeholder="enter no of next data" />
      <div class="input-group-append">
        <button class="btn btn-outline-primary" onclick="show()">Submit</button>
      </div>
    </div>
  </div>

  <div>
    <div id="myModal" class="modal fade" role="dialog">
      <div class="modal-dialog">
        <!-- Modal content-->
        <div class="modal-content">
          <div class="modal-header">
            <h4 class="modal-title">Task details</h4>
            <button type="button" class="close" data-dismiss="modal">
              &times;
            </button>
          </div>
          <div class="modal-body">
            <div class="card" id="showCard"></div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal">
              Close
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- Modal -->
  <div class="modal fade" id="exampleModaledit" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
    aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="exampleModalLabel">Edit task</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <div>
            <form enctype="multipart/form-data">
              <input type="hidden" id="movieid" />
              <div class="form-group">
                <label for="exampleInputEmail1">task name</label>
                <input type="text" class="form-control" id="tasktitle1" aria-describedby="emailHelp"
                  placeholder="Enter taskName" />
                <div id="tasktitlev1" class="error"></div>
              </div>

              <div class="form-group">
                <label for="exampleInputEmail1">priority</label>
                <input type="text" class="form-control" id="priority1" aria-describedby="emailHelp"
                  placeholder="Enter priority" />
                <div id="priorityv1" class="error"></div>
              </div>

              <div class="form-group">
                <label for="exampleInputEmail1">task image</label>
                <input type="file" class="form-control" id="image2" aria-describedby="emailHelp"
                  placeholder="Enter rating" />
                <div id="imagev2" class="error"></div>
              </div>
              <div class="form-group">
                <label for="exampleInputEmail1">task description</label>
                <textarea type="text" class="form-control" id="decription1" aria-describedby="emailHelp"
                  placeholder="Enter decription" rows="3"></textarea>
                <div id="decriptionv1" class="error"></div>
              </div>

              <button type="submit" class="btn btn-primary" onclick="event.preventDefault(); updateMovie();">
                update
              </button>
            </form>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">
            Close
          </button>
        </div>
      </div>
    </div>
  </div>

  <div>
    <div class="modal fade" id="exampleModaladd" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
      aria-hidden="true">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="exampleModalLabel">New Task</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <div>
              <form enctype="multipart/form-data">
                <div class="form-group">
                  <label for="exampleInputEmail1">Task title</label>
                  <input type="text" class="form-control" id="tasktilte" aria-describedby="emailHelp"
                    placeholder="Enter title" />
                  <div id="tasktiltev" class="error"></div>
                </div>
                <div class="form-group">
                  <label for="exampleInputEmail1">ToDate</label>
                  <input type="date" class="form-control" id="toDate" aria-describedby="emailHelp" />
                  <div id="toDatev" style="color: red"></div>
                </div>
                <div class="form-group">
                  <label for="exampleInputEmail1">priority</label>
                  <input type="text" class="form-control" id="priority" aria-describedby="emailHelp"
                    placeholder="Enter priority" />
                  <div id="priorityv" style="color: red"></div>
                </div>
                <div class="form-group">
                  <label for="exampleInputEmail1">task notes</label>
                  <input type="file" class="form-control" id="image1" aria-describedby="emailHelp" />
                  <div id="imagev" style="color: red"></div>
                </div>
                <div class="form-group">
                  <label for="exampleInputEmail1">Task description</label>
                  <textarea type="text" class="form-control" id="decription" aria-describedby="emailHelp"
                    placeholder="Enter decription" rows="3"></textarea>
                  <div id="decriptionv" style="color: red"></div>
                </div>

                <button type="submit" class="btn btn-primary" onclick="event.preventDefault(); addMovie();">
                  Add
                </button>
              </form>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">
              Close
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
  <script>
    var token;
    var headers = {};
    (function () {
      token = localStorage.getItem('token');
      headers['Authorization'] = token;
      show()
    })()

    function show() {
      addHtml = '';
      var fetchNo = document.getElementById('fetchNo').value;
      var skipNo = document.getElementById('skipNo').value;
      if (fetchNo.length == 0 && skipNo == 0) {
        fetchNo = 0;
        skipNo = 0;
      }
      $.ajax({
        type: 'GET',
        url:
          'http://localhost:4005/api/task/?skipNo=' +
          skipNo +
          '&fetchNo=' +
          fetchNo,
        headers: headers,
        // dataType: "json",
        success: (res) => {
          console.log('res', res.numOfdata);
          var i = 1;
          for (var data of res.data) {
            // console.log(data);
            addHtml += `<tr>
          <td scope="row">${i}</td>
          <td>${data.title}</td>
          <td><img src="${data.notes[0]}" style="width: 150px;height: 100px;" alt="movie image"/></td>
          <td><button class='btn btn-warning' id="${data._id}" data-toggle="modal" data-target="#exampleModaledit" onclick='editMovie(this.id)'>Edit</button></td>
                  <td><a class='btn btn-danger' id="${data._id}" onclick="deletemovie(this.id)">Delete</a></td>
                  <td><a class='btn btn-info' id="${data._id}" onclick="getmovie(this.id)" data-toggle="modal" data-target="#myModal">details</a></td>
        </tr>`;
            i++;
          }
          document.getElementById('showMovies').innerHTML = addHtml;
        },
      });

    }
    function getmovie(id) {
      
      var addHtml1 = '';
      $.ajax({
        type: 'GET',
        url: 'http://localhost:4005/api/task/' + id,
        headers: headers,
        // dataType: "json",
        success: (res) => {
          addHtml1 += ` <img
            class="card-img-top"
            src="${res.data.notes[0]}"
            style="width: 150px; height: 100px"
            alt="Card image cap"
          />
          <div class="card-body">
            <h5 class="card-title">Task name: ${res.data.title}</h5>
            <p class="card-text">Description: ${res.data.desc}</p>
          </div>
          <ul class="list-group list-group-flush">
            <li class="list-group-item">priority : ${res.data.priority}</li>
            <li class="list-group-item">
              toDate : ${res.data.toDate.split('T')[0]}
            </li>
          </ul>

          `;
          document.getElementById('showCard').innerHTML = addHtml1;
        },
      });
    }
    function addMovie() {
      const title = document.getElementById('tasktilte').value;
      const decription = document.getElementById('decription').value;
      const toDate = document.getElementById('toDate').value;
      const priority = document.getElementById('priority').value;
      const image = document.getElementById('image1').files[0];
      if (title.length <= 0) {
        document.getElementById('tasktiltev').innerHTML =
          'Task title is required';
        return false;
      }
      if (decription.length <= 0) {
        document.getElementById('decriptionv').innerHTML =
          'Movie description is required';
        return false;
      }

      if (toDate.length <= 0) {
        document.getElementById('toDatev').innerHTML =
          'Task toDate is required';
        return false;
      }
      if (priority.length <= 0) {
        document.getElementById('priorityv').innerHTML = 'priority is required';
        return false;
      }
      if (image.length <= 0) {
        document.getElementById('imagev').innerHTML = 'Movie image is required';
        return false;
      }
      else {
        var formdata = new FormData();
        formdata.append('title', title);
        formdata.append('desc', decription);
        formdata.append('toDate', toDate);
        formdata.append('priority', priority);
        formdata.append('image', image);
        $.ajax({
          type: 'POST',
          url: 'http://localhost:4005/api/task/add',
          data: formdata,
          headers: headers,
          processData: false,
          contentType: false,
          success: (res) => {
            if (res.error) {
              alert(res.error);
            } else {
              window.location.reload();
            }
          },
        });
      }
    }
    
    function deletemovie(id) {
      $.ajax({
        type: 'DELETE',
        url: 'http://localhost:4005/api/task/' + id,
        headers: headers,
        // dataType: "json",
        success: (res) => {
          debugger
          window.location.reload();
        },
      });
    }
    function taskFilter() {
      var name = document.getElementById('taskFilter').value;
      addHtml = '';
      $.ajax({
        type: 'POST',
        url: 'http://localhost:4005/api/task/',
        data: { name },
        headers: headers,
        dataType: 'json',
        success: (res) => {
          var i = 1;
          for (var data of res.data) {
            // console.log(data);
            addHtml += `<tr>
            <td scope="row">${i}</td>
        <td>${data.name}</td>
        <td><img src="${data.image}" style="width: 150px;height: 100px;" alt="movie image"/></td>
        <td><button class='btn btn-warning' id="${data._id}" data-toggle="modal" data-target="#exampleModaledit" onclick='editMovie(this.id)'>Edit</button></td>
                <td><a class='btn btn-danger' id="${data._id}" onclick="deletemovie(this.id)">Delete</a></td>
                <td><a class='btn btn-info' id="${data._id}" onclick="getmovie(this.id)" data-toggle="modal" data-target="#myModal">details</a></td>
     </tr>`;
            i++;
          }
          document.getElementById('showMovies').innerHTML = addHtml;
        },
      });
    }
    function editMovie(id) {
      $.ajax({
        type: 'GET',
        url: 'http://localhost:4005/api/task/' + id,
        headers: headers,
        // dataType: "json",
        success: (res) => {
          // console.log(res);
          debugger
          document.getElementById('tasktitle1').value = res.data.title;
          document.getElementById('taskid').value = res.data._id;
          document.getElementById('decription1').value = res.data.desc;
          document.getElementById('priority1').value = res.data.priority;
        },
      });
    }
 
  </script>